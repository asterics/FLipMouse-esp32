<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FLipMouse/FABI ESP32 firmware: /home/beni/sync/Projects/FH/FLipMouse-esp32/main/function_tasks/task_debouncer.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FLipMouse/FABI ESP32 firmware
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_5c982d53a68cdbcd421152b4020263a9.html">main</a></li><li class="navelem"><a class="el" href="dir_dd44d79ba9a472f66a6851d54403189f.html">function_tasks</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">task_debouncer.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>CONTINOUS TASK - This file contains the task implementation for the virtual button debouncer.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;freertos/FreeRTOS.h&gt;</code><br />
<code>#include &lt;freertos/event_groups.h&gt;</code><br />
<code>#include &lt;esp_event.h&gt;</code><br />
<code>#include &lt;esp_log.h&gt;</code><br />
<code>#include &lt;esp_timer.h&gt;</code><br />
<code>#include &quot;<a class="el" href="common_8h_source.html">common.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="config__switcher_8h_source.html">../config_switcher.h</a>&quot;</code><br />
</div>
<p><a href="task__debouncer_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:adb027d7ba5fa2f4d411182ff9bbe735a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="task__debouncer_8h.html#adb027d7ba5fa2f4d411182ff9bbe735a">DEBOUNCETIME_MS</a>&#160;&#160;&#160;50</td></tr>
<tr class="memdesc:adb027d7ba5fa2f4d411182ff9bbe735a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default time before debounce kicks in and a <a class="el" href="structraw__action.html" title="RAW VB action type, sent to debouncer_in queue. ">raw_action</a> input event is sent to the system event loop.  <a href="#adb027d7ba5fa2f4d411182ff9bbe735a">More...</a><br /></td></tr>
<tr class="separator:adb027d7ba5fa2f4d411182ff9bbe735a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19d09ecb1e435338ce694ac7181e65d3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="task__debouncer_8h.html#a19d09ecb1e435338ce694ac7181e65d3">DEBOUNCETIME_MIN_MS</a>&#160;&#160;&#160;10</td></tr>
<tr class="memdesc:a19d09ecb1e435338ce694ac7181e65d3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Minimum debounce time, anything below will be mapped directly.  <a href="#a19d09ecb1e435338ce694ac7181e65d3">More...</a><br /></td></tr>
<tr class="separator:a19d09ecb1e435338ce694ac7181e65d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac755d224eea4f51dbb1b9ad3bef592ab"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="task__debouncer_8h.html#ac755d224eea4f51dbb1b9ad3bef592ab">TASK_DEBOUNCER_STACKSIZE</a>&#160;&#160;&#160;2048</td></tr>
<tr class="separator:ac755d224eea4f51dbb1b9ad3bef592ab"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a79d88e490be7198b9cc37556c66b837b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="task__debouncer_8h.html#a79d88e490be7198b9cc37556c66b837b">task_debouncer</a> (void *param)</td></tr>
<tr class="memdesc:a79d88e490be7198b9cc37556c66b837b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Debouncing main task.  <a href="#a79d88e490be7198b9cc37556c66b837b">More...</a><br /></td></tr>
<tr class="separator:a79d88e490be7198b9cc37556c66b837b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>CONTINOUS TASK - This file contains the task implementation for the virtual button debouncer. </p>
<p>This debouncer task (task_debouncer) waits for incoming events (of type raw_action_t)on the debouncer_in queue. If an incoming event is registered, a timer (esp_timer) will be started. On a finished debounce event, the corresponding event is sent to the system event loop.</p>
<p>The debouncing itself can be controlled via following variables (these settings are located in the global config):</p>
<ul>
<li>Press debounce time</li>
<li>Release debounce time</li>
<li>Deadtime between two consecutive actions</li>
</ul>
<p>If one of these values is set for one dedicated VB, it will be used. If there is no setting, the device's default will be used. If the there is no default setting for this device, a hardcoded debounce time of DEBOUNCETIME_MS is used.</p>
<dl class="section note"><dt>Note</dt><dd>For each VB, a debouncer_cfg_t element will be used. The size of this array is determined by VB_MAX. Please set this define accordingly!</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="common_8h.html#ab5317f063728fccb634ed05f689185bf" title="Limiter value, used for checking&amp;accessing any arrays. ">VB_MAX</a> </dd>
<dd>
<a class="el" href="task__debouncer_8h.html#adb027d7ba5fa2f4d411182ff9bbe735a" title="Default time before debounce kicks in and a raw_action input event is sent to the system event loop...">DEBOUNCETIME_MS</a> </dd>
<dd>
<a class="el" href="common_8h.html#aff21ac3bb81c6f24c9eec496d07f899c" title="Queue for sending triggered actions to the debouncer task. ">debouncer_in</a> </dd>
<dd>
<a class="el" href="common_8h.html#a42e7ef86e94a9411c736c9e33c6e53f6" title="RAW VB action type, sent to debouncer_in queue. ">raw_action_t</a> </dd>
<dd>
<a class="el" href="common_8h.html#a1d17932316265a53a6982a2526a4cada" title="Complete configuration for the current settings. ">generalConfig_t</a> </dd></dl>

<p class="definition">Definition in file <a class="el" href="task__debouncer_8h_source.html">task_debouncer.h</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a19d09ecb1e435338ce694ac7181e65d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a19d09ecb1e435338ce694ac7181e65d3">&#9670;&nbsp;</a></span>DEBOUNCETIME_MIN_MS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBOUNCETIME_MIN_MS&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Minimum debounce time, anything below will be mapped directly. </p>

<p class="definition">Definition at line <a class="el" href="task__debouncer_8h_source.html#l00074">74</a> of file <a class="el" href="task__debouncer_8h_source.html">task_debouncer.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="task__debouncer_8c_source.html#l00366">task_debouncer()</a>.</p>

</div>
</div>
<a id="adb027d7ba5fa2f4d411182ff9bbe735a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb027d7ba5fa2f4d411182ff9bbe735a">&#9670;&nbsp;</a></span>DEBOUNCETIME_MS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBOUNCETIME_MS&#160;&#160;&#160;50</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Default time before debounce kicks in and a <a class="el" href="structraw__action.html" title="RAW VB action type, sent to debouncer_in queue. ">raw_action</a> input event is sent to the system event loop. </p>
<dl class="section note"><dt>Note</dt><dd>This debounce time is used, if no values are set in generalconfig. </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__debouncer_8h_source.html#l00071">71</a> of file <a class="el" href="task__debouncer_8h_source.html">task_debouncer.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="task__debouncer_8c_source.html#l00366">task_debouncer()</a>.</p>

</div>
</div>
<a id="ac755d224eea4f51dbb1b9ad3bef592ab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac755d224eea4f51dbb1b9ad3bef592ab">&#9670;&nbsp;</a></span>TASK_DEBOUNCER_STACKSIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define TASK_DEBOUNCER_STACKSIZE&#160;&#160;&#160;2048</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Stack size for debouncer task </p>

<p class="definition">Definition at line <a class="el" href="task__debouncer_8h_source.html#l00077">77</a> of file <a class="el" href="task__debouncer_8h_source.html">task_debouncer.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="flipmouse__fabi__esp32__kbdmouse__main_8c_source.html#l00114">app_main()</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a79d88e490be7198b9cc37556c66b837b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79d88e490be7198b9cc37556c66b837b">&#9670;&nbsp;</a></span>task_debouncer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void task_debouncer </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>param</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Debouncing main task. </p>
<p>This task is periodically testing the virtualButtonsIn flags for changes (DEBOUNCE_RESOLUTION_MS is used as delay between task wakeups). If a change is detected (either press or release flag for a virtualbutton is set), a timer is started.<br />
 Either the timer expires and the flag is mapped to virtualButtonsOut by debouncerCallback.<br />
 Or the input flag is cleared again by the responsible task and the debouncer cancels the timer as well (input was too short).</p>
<dl class="section see"><dt>See also</dt><dd>DEBOUNCERCHANNELS </dd>
<dd>
DEBOUNCE_RESOLUTION_MS </dd>
<dd>
<a class="el" href="task__debouncer_8c.html#a2d2e1703805d96b2612eb4d76407360c" title="Array of timer configs. ">xTimers</a> </dd>
<dd>
<a class="el" href="task__debouncer_8c.html#ac6452bd8cc5e6e526cba4212d4e5f755" title="Timer callback for debouncing. ">debouncerCallback</a> </dd>
<dd>
virtualButtonsIn </dd>
<dd>
virtualButtonsOut </dd></dl>
<dl class="section note"><dt>Note</dt><dd>This task is persistently running</dd></dl>
<p>This task is pending on raw actions, sent to the debouncer_in queue. If there is a raw action posted, this task either:</p><ul>
<li>Starts a new timer (no timer is running)</li>
<li>Cancels a running timer (timer is running in the opposite debouncer direction)</li>
<li>Does nothing (timer is already running in the same direction)</li>
</ul>
<dl class="section see"><dt>See also</dt><dd>DEBOUNCERCHANNELS </dd>
<dd>
DEBOUNCE_RESOLUTION_MS </dd>
<dd>
<a class="el" href="task__debouncer_8c.html#a2d2e1703805d96b2612eb4d76407360c" title="Array of timer configs. ">xTimers</a> </dd>
<dd>
<a class="el" href="task__debouncer_8c.html#ac6452bd8cc5e6e526cba4212d4e5f755" title="Timer callback for debouncing. ">debouncerCallback</a> </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000011">Todo:</a></b></dt><dd>Add anti-tremor &amp; deadtime functionality </dd></dl>
<dl class="section note"><dt>Note</dt><dd>We send here an additional release, just to be sure to release any actions (avoiding sticky actions for keys...)</dd>
<dd>
I think we should cancel only in the event of a set anti-tremor time. Otherwise we might loose e.g., key release events -&gt; sticky keys... </dd></dl>

<p class="definition">Definition at line <a class="el" href="task__debouncer_8c_source.html#l00366">366</a> of file <a class="el" href="task__debouncer_8c_source.html">task_debouncer.c</a>.</p>

<p class="reference">Referenced by <a class="el" href="flipmouse__fabi__esp32__kbdmouse__main_8c_source.html#l00114">app_main()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_cgraph.png" border="0" usemap="#task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_cgraph" alt=""/></div>
<map name="task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_cgraph" id="task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_cgraph">
<area shape="rect" id="node2" href="config__switcher_8c.html#a921538bec34d128a44a748fd5a2c391f" title="Get the current config struct. " alt="" coords="479,5,600,32"/>
<area shape="rect" id="node3" href="task__debouncer_8c.html#adc07ae860205196c6c285f6926bf2e04" title="Cancel a possibly running debouncing timer. " alt="" coords="493,107,586,133"/>
<area shape="rect" id="node4" href="task__debouncer_8c.html#ac7261ec119f3d0f8c09a484a3395caf8" title="Look for a possibly running debouncing timer. " alt="" coords="298,157,430,184"/>
<area shape="rect" id="node5" href="task__debouncer_8c.html#a9c2bdf28ee91c441212941b4ef5621ca" title="Start a timer with a given config and debounce time. " alt="" coords="168,107,249,133"/>
<area shape="rect" id="node6" href="task__debouncer_8c.html#ac6452bd8cc5e6e526cba4212d4e5f755" title="Timer callback for debouncing. " alt="" coords="297,56,431,83"/>
<area shape="rect" id="node7" href="task__debouncer_8c.html#aad304645b451a8b7ad60c9c6aab4e3d1" title="Send feedback on pressed buttons to host (for button learning) " alt="" coords="479,56,599,83"/>
<area shape="rect" id="node8" href="hal__serial_8c.html#af78683f30da18cfc19c2c91006ec6155" title="Send serial bytes to USB&#45;Serial (USB&#45;CDC) " alt="" coords="648,56,811,83"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_icgraph.png" border="0" usemap="#task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_icgraph" alt=""/></div>
<map name="task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_icgraph" id="task__debouncer_8h_a79d88e490be7198b9cc37556c66b837b_icgraph">
<area shape="rect" id="node2" href="flipmouse__fabi__esp32__kbdmouse__main_8c.html#abce06be17fc37d675118a678a8100a36" title="Main task, created by esp&#45;idf. " alt="" coords="168,5,247,32"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
