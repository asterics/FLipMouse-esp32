function FlipMouse(n){var I=this;I.AT_CMD_MAPPING={},I.SENSITIVITY_X="SENSITIVITY_X",I.SENSITIVITY_Y="SENSITIVITY_Y",I.ACCELERATION="ACCELERATION",I.MAX_SPEED="MAX_SPEED",I.DEADZONE_X="DEADZONE_X",I.DEADZONE_Y="DEADZONE_Y",I.SIP_THRESHOLD="SIP_THRESHOLD",I.SIP_STRONG_THRESHOLD="SIP_STRONG_THRESHOLD",I.PUFF_THRESHOLD="PUFF_THRESHOLD",I.PUFF_STRONG_THRESHOLD="PUFF_STRONG_THRESHOLD",I.ORIENTATION_ANGLE="ORIENTATION_ANGLE",I.LIVE_PRESSURE="LIVE_PRESSURE",I.LIVE_UP="LIVE_UP",I.LIVE_DOWN="LIVE_DOWN",I.LIVE_LEFT="LIVE_LEFT",I.LIVE_RIGHT="LIVE_RIGHT",I.LIVE_MOV_X="LIVE_MOV_X",I.LIVE_MOV_Y="LIVE_MOV_Y",I.LIVE_MOV_X_MIN="LIVE_MOV_X_MIN",I.LIVE_MOV_X_MAX="LIVE_MOV_X_MAX",I.LIVE_MOV_Y_MIN="LIVE_MOV_Y_MIN",I.LIVE_MOV_Y_MAX="LIVE_MOV_Y_MAX",I.LIVE_PRESSURE_MIN="LIVE_PRESSURE_MIN",I.LIVE_PRESSURE_MIN="LIVE_PRESSURE_MIN",I.LIVE_PRESSURE_MAX="LIVE_PRESSURE_MAX",I.FLIPMOUSE_MODE="FLIPMOUSE_MODE",I.SIP_PUFF_IDS=[L.getIDSelector(I.SIP_THRESHOLD),L.getIDSelector(I.SIP_STRONG_THRESHOLD),L.getIDSelector(I.PUFF_THRESHOLD),L.getIDSelector(I.PUFF_STRONG_THRESHOLD)];var c={},E={},t={},l=5,S={};S[I.SENSITIVITY_X]="AT AX",S[I.SENSITIVITY_Y]="AT AY",S[I.ACCELERATION]="AT AC",S[I.MAX_SPEED]="AT MS",S[I.DEADZONE_X]="AT DX",S[I.DEADZONE_Y]="AT DY",S[I.SIP_THRESHOLD]="AT TS",S[I.SIP_STRONG_THRESHOLD]="AT SS",S[I.PUFF_THRESHOLD]="AT TP",S[I.PUFF_STRONG_THRESHOLD]="AT SP",S[I.ORIENTATION_ANGLE]="AT RO",S[I.FLIPMOUSE_MODE]="AT MM";var s,a=Object.values(S),o={},i=null,O=null,T="Slot:",_="BUSY",u=(new Date).getTime(),r=[],f=!1,M=void 0;function e(n){i=n,L.isFunction(i)?(A("AT SR"),s.setValueHandler(V)):A("AT ER")}function V(n){if(L.isFunction(i))if(n&&-1!=n.indexOf("VALUES")){var e=n.split(":")[1].split(",");t[I.LIVE_PRESSURE]=parseInt(e[0]),t[I.LIVE_UP]=parseInt(e[1]),t[I.LIVE_DOWN]=parseInt(e[2]),t[I.LIVE_LEFT]=parseInt(e[3]),t[I.LIVE_RIGHT]=parseInt(e[4]),t[I.LIVE_MOV_X]=parseInt(e[5]),t[I.LIVE_MOV_Y]=parseInt(e[6]),t[I.LIVE_PRESSURE_MIN]=Math.min(t[I.LIVE_PRESSURE_MIN],t[I.LIVE_PRESSURE]),t[I.LIVE_MOV_X_MIN]=Math.min(t[I.LIVE_MOV_X_MIN],t[I.LIVE_MOV_X]),t[I.LIVE_MOV_Y_MIN]=Math.min(t[I.LIVE_MOV_Y_MIN],t[I.LIVE_MOV_Y]),t[I.LIVE_PRESSURE_MAX]=Math.max(t[I.LIVE_PRESSURE_MAX],t[I.LIVE_PRESSURE]),t[I.LIVE_MOV_X_MAX]=Math.max(t[I.LIVE_MOV_X_MAX],t[I.LIVE_MOV_X]),t[I.LIVE_MOV_Y_MAX]=Math.max(t[I.LIVE_MOV_Y_MAX],t[I.LIVE_MOV_Y]),i(t)}else console.log("error parsing live data: "+n);else s.setValueHandler(null)}function A(n){I.sendATCmd(n).then(function(){},function(){})}function d(n){var o=c[n];return new Promise(function(n){var t=[];Object.keys(o).forEach(function(n){var e=S[n];C.BTN_MODES.includes(n)?t.push(I.setButtonAction(n,o[n],!0)):n==I.FLIPMOUSE_MODE?t.push(I.setFlipmouseMode(o[n],!0)):t.push(I.sendATCmd(e+" "+o[n]))}),Promise.all(t).then(function(){n()})})}I.sendATCmd=function(t,n,e){var o=e||3e3;if(n&&0<r.length)return console.log('did not send cmd: "'+t+"' because another command is executing."),new Promise(function(n,e){e(_)});var i=new Promise(function(n,e){0<r.length&&console.log("adding cmd to queue: "+t),r.push({cmd:t,resolveFn:n,rejectFn:e})});return f||function n(){f=!0;if(0==r.length)return void(f=!1);var e=r.shift();var t=50-((new Date).getTime()-u);t=0<t?t:0;setTimeout(function(){u=(new Date).getTime(),console.log("sending to FlipMouse: "+e.cmd),s.sendData(e.cmd,o).then(e.resolveFn,e.rejectFn),n()},t)}(),i},I.sendATCmdWithParam=function(n,e,t){return I.sendATCmd(n+" "+e,!1,t)},I.testConnection=function(n){return new Promise(function(e){I.sendATCmd("AT",n).then(function(n){e(!!(n&&-1<n.indexOf("OK")))},function(n){e(!!(n&&-1<n.indexOf(_)))})})},I.setValue=function(n,e,t){t=t||300,I.setConfig(n,parseInt(e)),clearInterval(o[n]),o[n]=setTimeout(function(){A(S[n]+" "+e)},t)},I.refreshConfig=function(){return new Promise(function(e,n){I.sendATCmd("AT LA").then(function(n){!function(n){(function n(e,t){if(!e||0==e.length)return c;t=t||{};var o=e[0];var i=e[1];if(-1<o.indexOf(T)){var s=o.substring(T.length);O=O||s,t={},c[s]=t}else{var _=o.substring(0,l);if(a.includes(_)){var E=L.val2key(_,S);if(E==I.FLIPMOUSE_MODE){var u=parseInt(o.substring(l));t[E]=C.FLIPMOUSE_MODES[u]}else t[E]=parseInt(o.substring(l))}else if(-1<_.indexOf(C.AT_CMD_BTN_MODE)){var r=parseInt(o.substring(l));C.BTN_MODES[r-1]&&(t[C.BTN_MODES[r-1]]=i.trim())}}return n(e.slice(1),t)})(n.split("\n"))}(n),e()},function(){console.log("could not get config!"),n()})})},I.save=function(e){e=e||function(){},E={};var t=0;A("AT DE"),I.pauseLiveValueListener(),_(10);var s=50/I.getSlots().length,o=new Promise(function(i){!function n(e,t){if(t>=e.length)return void i();var o=e[t];I.testConnection().then(function(){d(o),I.testConnection().then(function(){A("AT SA "+o),_(s),n(e,t+1)})})}(I.getSlots(),0)});function _(n){e(t+=n)}return new Promise(function(n){o.then(function(){I.testConnection().then(function(){_(30),d(O).then(function(){_(10),I.resumeLiveValueListener(),n()})})})})},I.calibrate=function(){return A("AT CA"),I.testConnection()},I.rotate=function(){var n=I.getConfig(I.ORIENTATION_ANGLE);return I.setValue(I.ORIENTATION_ANGLE,(n+90)%360,0),A("AT CA"),I.testConnection()},I.startLiveValueListener=function(n){console.log("starting listening to live values..."),e(n)},I.stopLiveValueListener=function(){e(null),console.log("listening to live values stopped.")},I.pauseLiveValueListener=function(){I.sendATCmd("AT ER"),console.log("listening to live values stopped.")},I.resumeLiveValueListener=function(){i?(I.sendATCmd("AT SR"),console.log("listening to live values resumed.")):console.log("listening to live values not resumed, because no value handler.")},I.isSipAndPuffLive=function(){return new Promise(function(n,e){void 0!==M&&n(M),I.startLiveValueListener(function(){I.stopLiveValueListener(),n(M=!0)}),setTimeout(function(){I.stopLiveValueListener(),n(M=!1)},2e3)})},I.getConfig=function(n,e){return c[e=e||O]?c[e][n]:null},I.isConfigUnsaved=function(n,e){return!!E[e=e||O]&&-1<E[e].indexOf(n)},I.setConfig=function(n,e,t){c[t=t||O]&&(c[t][n]=e)},I.getSlots=function(){return Object.keys(c)},I.getCurrentSlot=function(){return O},I.setSlot=function(n){return I.getSlots().includes(n)&&A("AT LO "+(O=n)),c[O]},I.createSlot=function(n,e){return n&&!I.getSlots().includes(n)||console.warn("slot not saved because no slot name or slot already existing!"),c[n]=L.deepCopy(c[O]),A("AT SA "+(O=n)),e&&e(50),I.testConnection()},I.deleteSlot=function(n,e){return n&&I.getSlots().includes(n)||console.warn("slot not deleted because no slot name or slot not existing!"),delete c[n],n==O&&(O=I.getSlots()[0]),I.save(e)},I.getLiveData=function(n){return n?t[n]:t},I.resetMinMaxLiveValues=function(){t[I.LIVE_PRESSURE_MIN]=1024,t[I.LIVE_MOV_X_MIN]=1024,t[I.LIVE_MOV_Y_MIN]=1024,t[I.LIVE_PRESSURE_MAX]=-1,t[I.LIVE_MOV_X_MAX]=-1,t[I.LIVE_MOV_Y_MAX]=-1},I.setButtonAction=function(n,t,e){var o=C.BTN_MODES.indexOf(n)+1,i=("0"+o).slice(-2);if(o&&t)return e||(I.setConfig(n,t),E[O]=E[O]||[],E[O].push(n)),new Promise(function(n){var e=[];e.push(I.sendATCmd(C.AT_CMD_BTN_MODE+" "+i)),e.push(I.sendATCmd(t)),Promise.all(e).then(function(){n()})})},I.restoreDefaultConfiguration=function(n){var e=[];C.DEFAULT_CONFIGURATION.length;return e.push(I.sendATCmd("AT DE")),e.push(I.sendATCmd("AT LA")),e.push(I.calibrate()),new Promise(function(n){Promise.all(e).then(function(){n()})})},I.setFlipmouseMode=function(n,e){if(C.FLIPMOUSE_MODES.includes(n)){e||I.setConfig(I.FLIPMOUSE_MODE,n);var t=C.FLIPMOUSE_MODES.indexOf(n);A(S[I.FLIPMOUSE_MODE]+" "+t)}},new Promise(function(e){if(-1<window.location.href.indexOf("mock"))return s=new MockCommunicator,void e();ws.initWebsocket(C.FLIP_WEBSOCKET_URL).then(function(n){s=new WsCommunicator(C.FLIP_WEBSOCKET_URL,n),e()},function(){ws.initWebsocket(C.ARE_WEBSOCKET_URL).then(function(n){s=new ARECommunicator(n),e()},function(){console.warn("could not establish any websocket connection - using mock mode!"),s=new MockCommunicator,e()})})}).then(function(){I.resetMinMaxLiveValues(),I.refreshConfig().then(function(){L.isFunction(n)&&n(c[O])},function(){})})}